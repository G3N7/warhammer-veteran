# Tacticus Validation Rules - Machine-Readable Format
# CRITICAL: Load this BEFORE building any list. Check EVERY rule.
# Last Updated: 2025-12-28
# Version: 1.0

# ============================================================
# HARD RULES - Violations make list ILLEGAL
# ============================================================
hard_rules:

  rule_of_three:
    applies_to: "matched play"
    rule: "Max 3 units per datasheet (except BATTLELINE and DEDICATED TRANSPORT)"
    check: "Count units by datasheet name. If any non-exempt > 3, ILLEGAL."
    exempt_keywords: ["BATTLELINE", "DEDICATED TRANSPORT"]

  points_limit:
    rule: "Total points must be <= game size limit"
    limits: {500: 500, 1000: 1000, 2000: 2000}
    check: "Sum all unit points + enhancement points. If > limit, ILLEGAL."

  epic_hero_unique:
    rule: "Each Epic Hero can only appear once per army"
    check: "If same Epic Hero appears twice, ILLEGAL."

  enhancement_eligibility:
    rule: "Enhancements can ONLY be given to CHARACTER models without EPIC HERO keyword"
    check: "Before assigning enhancement, verify target.epic_hero == false AND 'CHARACTER' in target.keywords"
    common_error: "Assigning enhancements to named characters (Logan Grimnar, Shadowsun, etc.)"

  enhancement_limit:
    rule: "Max 1 enhancement per CHARACTER. Max enhancements = game size dependent."
    limits: {500: 1, 1000: 1, 2000: 3}
    check: "Count enhancements assigned. Count characters with enhancements."

  unit_sizes:
    rule: "Units must be legal sizes per datasheet"
    check: "unit.models must be in unit.sizes range"

# ============================================================
# VALIDATION GATES - Run in order before presenting any list
# ============================================================
validation_gates:

  gate_1_data_loaded:
    - "Faction datasheet loaded (compact.json)"
    - "Detachment rules known"
    - "Edition confirmed (10th Edition)"

  gate_2_unit_legality:
    - "Every unit exists in faction datasheet"
    - "Unit sizes are legal per datasheet"
    - "Wargear options are legal (if specified)"

  gate_3_composition:
    - "Rule of Three: count by datasheet, verify <= 3"
    - "Epic Heroes: verify unique, no duplicates"
    - "Enhancements: verify CHARACTER + not EPIC HERO"

  gate_4_points:
    - "Calculate: sum(unit.pts * unit.count) + sum(enhancement.pts)"
    - "Verify: total <= game_size"
    - "Show math: list each unit with calculation"

  gate_5_self_review:
    - "Check 3 potential issues with own work"
    - "Cross-reference prose vs table (model counts match)"

# ============================================================
# KNOWN CORRECTIONS - Overrides for datasheet errors
# When these units appear, use THESE values not cached data
# ============================================================
corrections:

  # Format: unit_name: {field: corrected_value, source: "where verified", date: "YYYY-MM-DD"}

  # Space Wolves corrections verified 2025-12-27
  arjac_rockfist:
    pts: 105
    epic_hero: true
    source: "New Recruit app"
    date: "2025-12-27"

  bjorn_the_fell_handed:
    pts: 160
    epic_hero: true
    source: "Wahapedia"
    date: "2025-12-27"

  logan_grimnar:
    pts: 110
    epic_hero: true
    source: "Wahapedia scrape"
    date: "2025-12-28"

  ragnar_blackmane:
    pts: 100
    epic_hero: true
    source: "Wahapedia scrape"
    date: "2025-12-28"

  murderfang:
    pts: 150
    epic_hero: true
    source: "Wahapedia scrape"
    date: "2025-12-28"

  # T'au corrections verified 2025-12-28
  commander_shadowsun:
    pts: 100
    epic_hero: true
    source: "Wahapedia scrape"
    date: "2025-12-28"

  commander_farsight:
    pts: 85
    epic_hero: true
    source: "Wahapedia scrape"
    date: "2025-12-28"

  longstrike:
    pts: 140
    epic_hero: true
    source: "Wahapedia scrape"
    date: "2025-12-28"

  # Astra Militarum corrections
  lord_solar_leontus:
    pts: 130
    epic_hero: true
    M: "12\""
    T: 4
    Sv: "3+"
    W: 8
    Ld: "6+"
    OC: 2
    invuln: "4+"
    source: "Wahapedia verified"
    date: "2025-12-29"

  leman_russ_punisher:
    pts: 150
    M: "10\""
    T: 11
    Sv: "2+"
    W: 13
    Ld: "7+"
    OC: 3
    note: "List file incorrectly showed 190pts"
    source: "Wahapedia verified"
    date: "2025-12-29"

  leman_russ_demolisher:
    pts: 190
    M: "10\""
    T: 11
    Sv: "2+"
    W: 13
    Ld: "7+"
    OC: 3
    source: "Wahapedia verified"
    date: "2025-12-29"

  ratlings:
    pts_5: 60
    pts_10: 100
    M: "6\""
    T: 2
    Sv: "6+"
    W: 1
    Ld: "8+"
    OC: 1
    abilities: ["Infiltrators", "Stealth", "Shoot Sharp and Scarper"]
    source: "Wahapedia verified"
    date: "2025-12-29"

  gaunts_ghosts:
    pts: 100
    epic_hero: true  # Ibram Gaunt is EPIC HERO
    models: 6
    source: "Wahapedia verified"
    date: "2025-12-29"

  # Orks corrections verified 2025-12-29
  big_mek:
    pts: 70
    M: "6\""
    T: 5
    Sv: "3+"
    W: 6
    Ld: "7+"
    OC: 1
    can_lead: ["Boyz", "Breaka Boyz", "Lootas", "Mek Gunz", "Nobz", "Tankbustas"]
    source: "Wahapedia verified"
    date: "2025-12-29"

  lootas:
    pts_5: 50
    pts_10: 100
    M: "6\""
    T: 5
    Sv: "5+"
    W: 1
    Ld: "7+"
    OC: 1
    source: "Wahapedia verified"
    date: "2025-12-29"

  # Tyranids - SYNAPSE clarification
  # These units do NOT have SYNAPSE keyword (common mistake)
  exocrine:
    has_synapse: false
    note: "Must stay in Synapse aura, does NOT provide it"
    source: "User correction"
    date: "2025-12-26"

  tyrannofex:
    has_synapse: false
    note: "Must stay in Synapse aura, does NOT provide it"
    source: "User correction"
    date: "2025-12-26"

  carnifexes:
    has_synapse: false
    note: "Must stay in Synapse aura, does NOT provide it"
    source: "User correction"
    date: "2025-12-26"

  # These DO have SYNAPSE
  hive_tyrant:
    has_synapse: true
    source: "Wahapedia"
    date: "2025-12-26"

  winged_hive_tyrant:
    has_synapse: true
    source: "Wahapedia"
    date: "2025-12-26"

  neurothrope:
    has_synapse: true
    source: "Wahapedia"
    date: "2025-12-26"

# ============================================================
# MISTAKE PATTERNS - Common errors to actively check for
# Format: pattern_name, description, prevention_check
# ============================================================
mistake_patterns:

  epic_hero_enhancement:
    description: "Assigning enhancements to Epic Heroes"
    frequency: "HIGH - happened 4+ times"
    prevention: "BEFORE assigning ANY enhancement: check unit.epic_hero == false"
    affected_units: ["Logan Grimnar", "Arjac Rockfist", "Commander Shadowsun", "Lord Solar Leontus", "Longstrike"]

  points_overage:
    description: "List exceeds points limit"
    frequency: "MEDIUM - happened 3 times"
    prevention: "Re-add all units BEFORE presenting. Never assume math is correct."

  outdated_wargear:
    description: "Using wargear from previous editions"
    frequency: "MEDIUM - Wolf Guard Terminators thunder hammers"
    prevention: "Verify wargear against current datasheet. 10th Ed changed many options."

  keyword_hallucination:
    description: "Claiming units have keywords they don't have (SYNAPSE, DEEP STRIKE)"
    frequency: "LOW - Tyranid SYNAPSE error"
    prevention: "Only claim keywords that appear in datasheet.keywords or datasheet.core"

  prose_table_mismatch:
    description: "Model counts in prose sections don't match army table"
    frequency: "LOW"
    prevention: "After writing tactics/strengths, cross-reference model counts against table"

# ============================================================
# DETACHMENT ENHANCEMENTS - Quick reference
# ============================================================
detachments:

  # === SPACE WOLVES ===
  saga_of_the_beastslayer:
    faction: "Space Wolves"
    ability: "Lethal Hits vs CHARACTER, MONSTER, VEHICLE"
    enhancements:
      - {name: "Blade of the Slayer", pts: 25, effect: "+1 Strength and Damage for melee"}
      - {name: "Hunter's Instincts", pts: 20, effect: "+2\" Move, Advance/charge after Advance"}
      - {name: "The Pelt of Balewolf", pts: 15, effect: "Enemy units -1 to hit in melee"}
      - {name: "Black Death", pts: 15, effect: "Anti-INFANTRY 4+, Anti-MOUNTED 4+ melee"}

  # === SPACE MARINES (Ultramarines) ===
  gladius_task_force:
    faction: "Space Marines"
    ability: "Combat Doctrines: Devastating Wounds (turn 1), Sustained Hits 1 (turn 2), Lethal Hits (turn 3+)"
    enhancements:
      - {name: "Adept of the Codex", pts: 20, effect: "Once per battle, change Combat Doctrine for your army"}
      - {name: "Artificer Armour", pts: 10, effect: "2+ Save, 5+ Feel No Pain vs mortal wounds"}
      - {name: "Fire Discipline", pts: 30, effect: "Ranged attacks score critical hits on 5+"}
      - {name: "The Honour Vehement", pts: 15, effect: "Melee attacks get Lethal Hits + Devastating Wounds turn 3+"}

  # === T'AU EMPIRE ===
  kauyon:
    faction: "T'au Empire"
    ability: "Full re-rolls to hit if unit remained stationary"
    enhancements:
      - {name: "Puretide Engram Neurochip", pts: 25, effect: "Once per battle, re-roll all hits and wounds"}
      - {name: "Precision of the Patient Hunter", pts: 20, effect: "Ranged weapons gain [IGNORES COVER]"}
      - {name: "Through Unity, Devastation", pts: 40, effect: "Aura: Core units re-roll 1s to wound"}
      - {name: "The Be'gel Hunter's Plate", pts: 15, effect: "4+ invulnerable save"}

  mont_ka:
    faction: "T'au Empire"
    ability: "Re-roll Advance/Charge. +1 to hit if target is closest eligible."
    enhancements:
      - {name: "Exemplar of the Mont'ka", pts: 25, effect: "Unit falls back and still shoots/charges"}
      - {name: "Precision of the Killing Blow", pts: 20, effect: "[PRECISION] on all ranged weapons"}
      - {name: "Starflare Ignition System", pts: 20, effect: "Once per battle, 12\" move after shooting"}
      - {name: "The Thermoneutronic Projector", pts: 30, effect: "Flamer weapons get +1 Strength and Damage"}

  # === ASTRA MILITARUM ===
  grizzled_company:
    faction: "Astra Militarum"
    ability: "Ignore modifiers to hit and wound, ignore cover"
    enhancements:
      - {name: "Grand Strategist", pts: 15, effect: "CP on 5+ when opponent uses Stratagem"}
      - {name: "Drill Commander", pts: 20, effect: "Ordered unit +1 to hit"}
      - {name: "Death Mask of Ollanius", pts: 10, effect: "6\" aura: models flee on 2+ instead of auto"}
      - {name: "Gatekeeper", pts: 20, effect: "Lasgun weapons get +6\" range and [LETHAL HITS]"}

  combined_regiment:
    faction: "Astra Militarum"
    ability: "Infantry units count as being in range of an Officer for Orders"
    enhancements:
      - {name: "Cadia Stands!", pts: 15, effect: "Once per battle, unit fights on death"}
      - {name: "Death World Veteran", pts: 20, effect: "+1 Attacks, +1 Toughness"}
      - {name: "Regimental Standard", pts: 15, effect: "12\" aura: re-roll Battle-shock tests"}
      - {name: "Vox-caster", pts: 5, effect: "Orders affect units 24\" away"}

  # === ORKS ===
  dread_mob:
    faction: "Orks"
    ability: "WALKERS get 5+ Feel No Pain. Big Meks repair D3+1 wounds."
    enhancements:
      - {name: "Choppa Hauler", pts: 25, effect: "VEHICLE gains [DEADLY DEMISE D3]"}
      - {name: "Kustom Shokka", pts: 15, effect: "Shokk Attack Gun gains [DEVASTATING WOUNDS]"}
      - {name: "Orky Know-Wots", pts: 20, effect: "Big Mek: healed model fights immediately"}
      - {name: "Smoky Gubbinz", pts: 15, effect: "Benefit of Cover always, -1 to be hit"}

  waaagh_tribe:
    faction: "Orks"
    ability: "Call a Waaagh!: +1 Strength, +1 Attack, charge after Advance"
    enhancements:
      - {name: "'Eadwoppa's Killchoppa", pts: 25, effect: "One melee weapon: [DEVASTATING WOUNDS]"}
      - {name: "Brutal but Kunnin'", pts: 15, effect: "Once per battle: melee attacks auto-wound"}
      - {name: "Follow Me Ladz!", pts: 25, effect: "+3\" to charges for led unit"}
      - {name: "Supa-Cybork Body", pts: 15, effect: "4+ Feel No Pain"}

  # === TYRANIDS ===
  crusher_stampede:
    faction: "Tyranids"
    ability: "MONSTER units reduce AP by 1. Get +1 OC when below Starting Strength."
    enhancements:
      - {name: "Adaptive Biology", pts: 25, effect: "4+ Feel No Pain after first wound taken"}
      - {name: "Enraged Reserves", pts: 15, effect: "+1 Attack and Strength when below half wounds"}
      - {name: "Synaptic Linchpin", pts: 20, effect: "Synapse range extended to 9\""}
      - {name: "Rampaging Beast", pts: 15, effect: "Re-roll charge rolls, +1 Attack on charge"}

  invasion_fleet:
    faction: "Tyranids"
    ability: "Synapse Imperative: choose buff each Command phase for Synapse units"
    enhancements:
      - {name: "Alien Cunning", pts: 30, effect: "Redeploy up to 3 units pre-game"}
      - {name: "Perfectly Adapted", pts: 15, effect: "Re-roll one hit, wound, damage, or save per turn"}
      - {name: "Synaptic Control", pts: 20, effect: "12\" aura: re-roll Battle-shock"}
      - {name: "The Dirgeheart of Kharis", pts: 20, effect: "Once per battle, enemy unit -1 to hit you"}

# ============================================================
# META SNAPSHOT - December 2025
# Refresh: Monthly or after balance dataslate
# ============================================================
meta:
  last_updated: "2025-12-23"
  dataslate: "December 2025"

  s_tier:
    - "Astra Militarum"
    - "Space Marines (various chapters)"
    - "Drukhari"
    - "Chaos Daemons"
    - "Death Guard"

  notes:
    - "Aeldari nerfed hard (Skyborne Sanctuary changes)"
    - "T'au + GSC left untouched despite needing help"
    - "Tank-heavy armies stable"
